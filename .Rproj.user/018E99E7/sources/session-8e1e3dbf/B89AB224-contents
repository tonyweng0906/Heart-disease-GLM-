---
title: "MATH 6622 Project"
output:
  pdf_document: default
  html_document:
    df_print: paged
date: "2025-03-22"
---

```{r setup, echo = FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Description of Dataset
```{r, echo=FALSE}
library(ggplot2)
library(corrplot)
library(ggpubr)
library(knitr)
dat<-read.csv('heart.csv')
```

Our data contain 918 observations with 12 variables:


HeartDisease: output class [1: heart disease, 0: Normal] (This is the response variable)

Age: age of the patient [years] (Continuous)

Sex: sex of the patient [M: Male, F: Female] (Categorical)

ChestPainType: chest pain type [TA: Typical Angina, ATA: Atypical Angina, NAP: Non-Anginal Pain, ASY: Asymptomatic] (Categorical)

RestingBP: resting blood pressure [mm Hg] (Continuous)

Cholesterol: serum cholesterol [mm/dl] (Continuous)

FastingBS: fasting blood sugar [1: if FastingBS > 120 mg/dl, 0: otherwise] (Categorical)

RestingECG: resting electrocardiogram results [Normal: Normal, ST: having ST-T wave abnormality (T wave inversions and/or ST elevation or depression of > 0.05 mV), LVH: showing probable or definite left ventricular hypertrophy by Estes' criteria] (Categorical)

MaxHR: maximum heart rate achieved [Numeric value between 60 and 202] (Continuous)

ExerciseAngina: exercise-induced angina [Y: Yes, N: No] (Categorical)

Oldpeak: oldpeak = ST [Numeric value measured in depression] (Continuous)

ST_Slope: the slope of the peak exercise ST segment [Up: upsloping, Flat: flat, Down: downsloping] (Categorical)



# Objectives

Our analysis aims to answer the following questions:


1. What factors in the dataset have significant impacts on probability of getting heart disease?

2. How and to what extent do those factors influence the probability of getting heart disease?


In addition, we will develop a statistical model to predict the probability of getting heart disease.


# Exploratory Data Analysis


## Check for missing value
```{r echo = FALSE}
sapply(dat, function(x) sum(is.na(x)))
```

There is no missing value from the dataset.


## Numerical Summaries

```{r echo = FALSE}
# Summary of numeric variables
kable(summary(dat[, c("Age", "RestingBP","Cholesterol", "MaxHR", "Oldpeak")]))
```

## Distribution of Numerical Covariates

```{r echo = FALSE}

# Histogram for numerical variables
num_vars <- sapply(dat, is.numeric)
hist1<-ggplot(dat, aes(x = Age)) + geom_histogram(bins = 30 , alpha = 0.7) + labs(title = "Age")
hist2<-ggplot(dat, aes(x = RestingBP)) + geom_histogram(bins = 30, , alpha = 0.7) + labs(title = "Resting Blood Pressure")
hist3<-ggplot(dat, aes(x = Cholesterol)) + geom_histogram(bins = 30 , alpha = 0.7) + labs(title = "Cholesterol")
hist4<-ggplot(dat, aes(x = MaxHR)) + geom_histogram(bins = 30, , alpha = 0.7) + labs(title = "Max Heart Rate")
hist5<-ggplot(dat, aes(x = MaxHR)) + geom_histogram(bins = 30, , alpha = 0.7) + labs(title = "OldPeak")

ggarrange(hist1,hist2,hist3,hist4,hist5, ncol = 3, nrow = 2)
```

The distribution for most variables appear to be approximately normal, except for cholesterol level where the value for a remarkable number of patients is 0.


## Relationship between Categorical Covariates and Heart Disease

```{r echo = FALSE}
# Bar plot for categorical variables
bar1<-ggplot(dat, aes(x = Sex, fill = factor(HeartDisease))) + geom_bar() + labs(title = "Heart Disease by Sex", fill = "Heart Disease")
bar2<-ggplot(dat, aes(x = ChestPainType, fill = factor(HeartDisease))) + geom_bar() + labs(title = "Heart Disease by Chest Pain Type", fill = "Heart Disease")
bar3<-ggplot(dat, aes(x = ExerciseAngina, fill = factor(HeartDisease))) + geom_bar() + labs(title = "Heart Disease by Exercise Angina", fill = "Heart Disease")

ggarrange(bar1,bar2,bar3, ncol = 2, nrow = 2)
```

The proportion of male patients with heart disease is greater than proportion of female patients. The probability of heart disease significantly differ by chest pain type, where type ASY: Asymptomatic most likely leads to heart disease, while type ATA: Atypical Angina least likely results in heart disease. Exercise-induced angina also increases the likelihood of getting heart disease sharply.


## Correlation visualization

```{r echo = FALSE}
cor_matrix <- cor(dat[num_vars])

par(mfrow=c(1,2))
corrplot(cor_matrix, method = "circle", type = "upper", tl.cex = 0.8)
corrplot(cor_matrix, method="number")
```

The factors age, larger fasting blood sugar and oldpeak (ST depression induced by exercise relative to rest) are moderately positively correlated with heart disease. Resting blood pressure is mildly positively correlated with heart disease. Cholesterol level and maximum heart rate achieved are negatively correlated with heart disease.


# Statistical Models and Methodology

## Sequential Log-Likelihood Ratio Tests

We use sequential log-likelihood ratio tests to test nested models starting from the model with all parameters and choose the variable with the highest p-value (most insignificant variable) to perform log-likelihood ratio tests for nested models. If the p-value is larger than 0.05, then the model with that variable excluded is better. This procedure is repeated until the model is not reducible. We follow this procedure to get the best model for each link (logit, probit and complementary log-log).

### Logit Link
```{r echo = FALSE}
dat$Sex <- as.factor(dat$Sex)
dat$ChestPainType <- as.factor(dat$ChestPainType)
dat$RestingECG <- as.factor(dat$RestingECG)
dat$ExerciseAngina <- as.factor(dat$ExerciseAngina)
dat$ST_Slope <- as.factor(dat$ST_Slope)

# Full model with all predictors
full_model <- glm(HeartDisease ~ Age + Sex + ChestPainType + RestingBP + Cholesterol + 
                  FastingBS + RestingECG + MaxHR + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "logit"))

p_values <- summary(full_model)$coefficients[, 4]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_full<-summary(full_model)$deviance

# Remove RestingECGNormal

model_1<-glm(HeartDisease ~ Age + Sex + ChestPainType + RestingBP + Cholesterol + 
                  FastingBS + MaxHR + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "logit"))

lr_test_1 <- anova(model_1, full_model, test = "Chisq")
cat("Comparison of model 1 and full model:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_1$Deviance[2], "\n")
cat("p-value: ", lr_test_1$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_1)$coefficients[, 4]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_1<-summary(model_1)$deviance


# Remove RestingBP

model_2<-glm(HeartDisease ~ Age + Sex + ChestPainType + Cholesterol + 
                  FastingBS + MaxHR + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "logit"))

lr_test_2 <- anova(model_2, model_1, test = "Chisq")
cat("Comparison of model 2 and model 1:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_2$Deviance[2], "\n")
cat("p-value: ", lr_test_2$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_2)$coefficients[, 4][-1]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_2<-summary(model_2)$deviance


# Remove MaxHR

model_3<-glm(HeartDisease ~ Age + Sex + ChestPainType + Cholesterol + 
                  FastingBS + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "logit"))

lr_test_3 <- anova(model_3, model_2, test = "Chisq")
cat("Comparison of model 3 and model 2:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_3$Deviance[2], "\n")
cat("p-value: ", lr_test_3$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_3)$coefficients[, 4]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_3<-summary(model_3)$deviance


# Remove Age

model_4<-glm(HeartDisease ~ Sex + ChestPainType + Cholesterol + 
                  FastingBS + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "logit"))

lr_test_4 <- anova(model_4, model_3, test = "Chisq")
cat("Comparison of model 4 and model 3:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_4$Deviance[2], "\n")
cat("p-value: ", lr_test_4$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_4)$coefficients[, 4][-1]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_4<-summary(model_4)$deviance

# Try removing ST_Slope

model_5<-glm(HeartDisease ~ Sex + ChestPainType + Cholesterol + 
                  FastingBS + ExerciseAngina + Oldpeak, 
                  data = dat, family = binomial(link = "logit"))

lr_test_5 <- anova(model_5, model_4, test = "Chisq")
cat("Comparison of model 5 and model 4:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_5$Deviance[2], "\n")
cat("p-value: ", lr_test_5$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_5)$coefficients[, 4][-1]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_5<-summary(model_5)$deviance

# Fail to remove ST_Slope, model 4 is best model
best_logit_model<-model_4
```
Model 4 is not reducible anymore, thus this is the best model using logit link.


### Probit Link

```{r echo = FALSE}
dat$Sex <- as.factor(dat$Sex)
dat$ChestPainType <- as.factor(dat$ChestPainType)
dat$RestingECG <- as.factor(dat$RestingECG)
dat$ExerciseAngina <- as.factor(dat$ExerciseAngina)
dat$ST_Slope <- as.factor(dat$ST_Slope)

# Full model with all predictors
full_model <- glm(HeartDisease ~ Age + Sex + ChestPainType + RestingBP + Cholesterol + 
                  FastingBS + RestingECG + MaxHR + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "probit"))

p_values <- summary(full_model)$coefficients[, 4]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_full<-summary(full_model)$deviance

# Remove RestingECGNormal

model_1<-glm(HeartDisease ~ Age + Sex + ChestPainType + RestingBP + Cholesterol + 
                  FastingBS + MaxHR + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "probit"))

lr_test_1 <- anova(model_1, full_model, test = "Chisq")
cat("Comparison of model 1 and full model:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_1$Deviance[2], "\n")
cat("p-value: ", lr_test_1$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_1)$coefficients[, 4]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_1<-summary(model_1)$deviance

# Remove MaxHR

model_2<-glm(HeartDisease ~ Age + Sex + ChestPainType + RestingBP + Cholesterol + 
                  FastingBS + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "probit"))

lr_test_2 <- anova(model_2, model_1, test = "Chisq")
cat("Comparison of model 2 and model 1:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_2$Deviance[2], "\n")
cat("p-value: ", lr_test_2$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_2)$coefficients[, 4]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_2<-summary(model_2)$deviance

# Remove RestingBP

model_3<-glm(HeartDisease ~ Age + Sex + ChestPainType + Cholesterol + 
                  FastingBS + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "probit"))

lr_test_3 <- anova(model_3, model_2, test = "Chisq")
cat("Comparison of model 3 and model 2:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_3$Deviance[2], "\n")
cat("p-value: ", lr_test_3$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_3)$coefficients[, 4]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values)
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_3<-summary(model_3)$deviance

# See if Age can be removed

model_4<-glm(HeartDisease ~ Sex + ChestPainType + Cholesterol + 
                  FastingBS + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "probit"))

lr_test_4 <- anova(model_4, model_3, test = "Chisq")
cat("Comparison of model 4 and model 3:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_4$Deviance[2], "\n")
cat("p-value: ", lr_test_4$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_4)$coefficients[, 4][-1]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values)
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_4<-summary(model_4)$deviance

# Fail to remove Age, model 3 is best model
best_probit_model<-model_3
```
The best probit model is model 3 as it cannot be reduced anymore.

### Complementary Log-log Link

```{r echo = FALSE}
dat$Sex <- as.factor(dat$Sex)
dat$ChestPainType <- as.factor(dat$ChestPainType)
dat$RestingECG <- as.factor(dat$RestingECG)
dat$ExerciseAngina <- as.factor(dat$ExerciseAngina)
dat$ST_Slope <- as.factor(dat$ST_Slope)

# Full model with all predictors
full_model <- glm(HeartDisease ~ Age + Sex + ChestPainType + RestingBP + Cholesterol + 
                  FastingBS + RestingECG + MaxHR + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "cloglog"))

p_values <- summary(full_model)$coefficients[, 4]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_full<-summary(full_model)$deviance

# Remove RestingECGNormal

model_1<-glm(HeartDisease ~ Age + Sex + ChestPainType + RestingBP + Cholesterol + 
                  FastingBS + MaxHR + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "cloglog"))

lr_test_1 <- anova(model_1, full_model, test = "Chisq")
cat("Comparison of model 1 and full model:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_1$Deviance[2], "\n")
cat("p-value: ", lr_test_1$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_1)$coefficients[, 4]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_1<-summary(model_1)$deviance


# Remove Age

model_2<-glm(HeartDisease ~ Sex + ChestPainType + RestingBP + Cholesterol + 
                  FastingBS + MaxHR + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "cloglog"))

lr_test_2 <- anova(model_2, model_1, test = "Chisq")
cat("Comparison of model 2 and model 1:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_2$Deviance[2], "\n")
cat("p-value: ", lr_test_2$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_2)$coefficients[, 4][-1]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_2<-summary(model_2)$deviance


# Remove RestingBP

model_3<-glm(HeartDisease ~ Sex + ChestPainType + Cholesterol + 
                  FastingBS + MaxHR + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "cloglog"))

lr_test_3 <- anova(model_3, model_2, test = "Chisq")
cat("Comparison of model 3 and model 2:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_3$Deviance[2], "\n")
cat("p-value: ", lr_test_3$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_3)$coefficients[, 4][-1]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_3<-summary(model_3)$deviance


# Remove MaxHR

model_4<-glm(HeartDisease ~ Sex + ChestPainType + Cholesterol + 
                  FastingBS + ExerciseAngina + Oldpeak + ST_Slope, 
                  data = dat, family = binomial(link = "cloglog"))

lr_test_4 <- anova(model_4, model_3, test = "Chisq")
cat("Comparison of model 4 and model 3:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_4$Deviance[2], "\n")
cat("p-value: ", lr_test_4$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_4)$coefficients[, 4][-1]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_4<-summary(model_4)$deviance

# Try removing OldPeak

model_5<-glm(HeartDisease ~ Sex + ChestPainType + Cholesterol + 
                  FastingBS + ExerciseAngina + ST_Slope, 
                  data = dat, family = binomial(link = "cloglog"))

lr_test_5 <- anova(model_5, model_4, test = "Chisq")
cat("Comparison of model 5 and model 4:\n")
cat("Log-Likelihood Ratio/Deviance Test statistic: ", lr_test_5$Deviance[2], "\n")
cat("p-value: ", lr_test_5$`Pr(>Chi)`[2], "\n")

p_values <- summary(model_5)$coefficients[, 4][-1]
predictor_to_remove <- names(p_values)[which.max(p_values)]
max_p_value <- max(p_values[-1])
paste("Next covariate to remove:", predictor_to_remove, "| p-value:", max_p_value)
deviance_5<-summary(model_5)$deviance

# Fail to remove OldPeak, best model is model_4
best_cloglog_model<-model_4
```
The best complementary log-log model is given by model 4 as it cannot be reduced.


## Comparing the best logit, probit and complementary log-log model

```{r echo = FALSE}
paste('Formula of best logit model')
best_logit_model$formula
paste('Formula of best probit model')
best_probit_model$formula
paste('Formula of best cloglog model')
best_cloglog_model$formula
paste('DF of best logit model:',best_logit_model$df.residual)
paste('DF of best probit model:',best_probit_model$df.residual)
paste('DF of best cloglog model:',best_cloglog_model$df.residual)
paste('Deviance of best logit model',summary(best_logit_model)$deviance)
paste('Deviance of best probit model',summary(best_probit_model)$deviance)
paste('Deviance of best cloglog model',summary(best_cloglog_model)$deviance)
```

We compare the best model for each link. The probit model has the smallest deviance, but it has one more parameter than logit model (the residual degree of freedom of probit model is 1 less than logit model). And since the deviance of logit model is marginally greater than probit model, the prediction power of the two models are roughly similar. However, parameters in the logit model are the most interpretable, thus the logistic regression is best for result analysis.


# Model Diagnostics and Jusitification 

We perform model diagnostics for both logit and probit link since their prediction power is similar based on their deviance and degree of freedom of residuals.

## Goodness-of-Fit Test

## Pearson Residuals

# Interpretation of Results

## Parameter Estimation, Confidence Intervals and Estimated Odds Ratio

We use the logistic regression or logit link for this part, since logistic regression gives the best interpretability.

# Conclusions




